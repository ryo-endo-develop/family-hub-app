# Backend Design Documentation (FamilyHubApp)

## ディレクトリ構成

このバックエンドアプリケーションは、関心事の分離を目的として以下のディレクトリ構成を採用しています。

```
├── app/                   # メインのアプリケーションコード
│   ├── init.py
│   ├── main.py          # FastAPI App Entrypoint
│   ├── core/            # コア設定・共通関数 (例: config.py)
│   ├── db/              # DB接続・セッション管理 (例: session.py)
│   ├── models/          # DBモデル定義 (SQLModel) (例: family.py, user.py, task.py)
│   ├── schemas/         # APIスキーマ定義 (Pydantic/SQLModel) (例: family.py, user.py, task.py)
│   ├── crud/            # CRUD操作関数 (例: crud_family.py, crud_user.py, crud_task.py)
│   └── routers/         # APIエンドポイント(ルーティング)定義
│       └── api_v1/      # APIバージョン管理 (例: v1)
│           └── endpoints/ # 各リソースのエンドポイント (例: families.py, users.py, tasks.py)
├── tests/                 # ★ テストコード用ディレクトリ ★
│   ├── init.py
│   ├── conftest.py        # pytestの共通設定・フィクスチャ
│   ├── crud/            # CRUD関数のテスト
│   │   └── test_crud_task.py
│   └── routers/         # APIエンドポイントのテスト
│       └── test_tasks.py
├── .env                 # 環境変数 (Git管理外)
├── .env.example         # 環境変数サンプル
├── .gitignore           # Git無視リスト
├── Dockerfile           # FastAPIアプリ用Dockerfile
├── docker-compose.yml   # Docker Compose設定
├── pyproject.toml       # プロジェクト設定 (Ruffなど)
└── requirements.txt     # Python依存ライブラリ
```

### 各ディレクトリの役割

- **`app/`**: アプリケーションの主要なソースコードが含まれます。
  - **`core/`**: 設定ファイルや共通のユーティリティ関数など。
  - **`db/`**: データベースセッションの管理など、データベース接続に関連するコード。
  - **`models/`**: データベースのテーブル構造に対応する SQLModel クラス。
  - **`schemas/`**: API リクエスト/レスポンスのデータ形式を定義する Pydantic/SQLModel クラス。
  - **`crud/`**: データベースに対する基本的な作成(Create)、読み取り(Read)、更新(Update)、削除(Delete)操作を行う関数群。ビジネスロジックは最小限に。
  - **`routers/`**: API のエンドポイントを定義し、リクエストを受け付け、適切な CRUD 関数やビジネスロジックを呼び出す部分。
- **`tests/`**: 自動テストのコードが含まれます。（後述）
- **(ルートディレクトリ)**: Docker 設定ファイル、依存関係ファイル、プロジェクト設定ファイルなど。

## テスト戦略

### 基本方針

本プロジェクトにおけるテストの主な目的は、コア機能の正常動作を確認し、重要な箇所でのリグレッション（意図しない変更によるバグの再発）を防ぎ、リファクタリングを安心して行えるようにすることです。開発スピードを優先し、網羅的なテストや高いコードカバレッジ率を目標とはせず、ビジネス価値の高い部分に絞って意味のあるテストを記述します。

### 使用ツール

- テストランナー: `pytest`
- API テストクライアント: `httpx` (FastAPI の`TestClient`経由で使用)

### テスト環境

- 開発中および CI におけるテストの実行速度を重視し、原則として**インメモリ SQLite データベース** (`sqlite+aiosqlite:///:memory:`) を使用します。
- **注意点:** SQLite と本番環境の PostgreSQL では、JSON 型の扱い、特定の SQL 関数、制約の挙動などに差異が生じる可能性があります。PostgreSQL 固有の機能に強く依存するテストが必要になった場合は、別途テスト用 PostgreSQL 環境での確認を検討します。

### テスト対象の優先順位

1.  **API エンドポイント (インテグレーションテスト - 最優先):**

    - FastAPI の`TestClient`を使用し、API へのリクエストとレスポンスを検証します。
    - **テスト内容:**
      - 主要リソース（Task, Family 等）の基本的な CRUD 操作（作成/一覧取得/詳細取得/更新/削除）の正常系（ハッピーパス）。
      - **認可:** マルチテナントにおける最重要項目。異なる家族のデータにアクセスできないこと、適切な権限がないと操作できないことなどをテストします。
      - 基本的なリクエストバリデーション（必須項目、型など）に対するエラーレスポンス（主に 422）の確認。
    - **配置場所:** `tests/routers/`

2.  **複雑なビジネスロジック (ユニットテスト - 必要に応じて):**
    - 将来的に実装される可能性のある、単なる DB 操作以上の複雑なロジック（定常タスクの計算等）は、該当モジュールに対してユニットテストを記述します。DB アクセス等はモック化することもあります。
    - **配置場所:** `tests/` 以下にロジックに対応するテストファイルを作成。

### テスト対象としないもの（初期）

- **単純な Models/Schemas 定義:** カスタムバリデーション等を含まない限り、これらの定義自体を直接テストすることはしません。API テスト等で間接的に検証されます。
- **全ての境界値・エッジケース:** まずは主要なシナリオをカバーします。
- **外部ライブラリ自体のテスト:** FastAPI や SQLModel 等が正しく動作することは前提とします。

### テストファイルの構成

テストコードはプロジェクトルートの `tests/` ディレクトリに配置し、`app/` ディレクトリの構造を参考にファイルを整理します (例: `tests/routers/test_tasks.py`)。共通のテスト設定やフィクスチャは `tests/conftest.py` に記述します。
