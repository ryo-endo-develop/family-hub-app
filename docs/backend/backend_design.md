# Backend Design Documentation (FamilyHubApp)

## アーキテクチャ方針

### 基本アーキテクチャ

本バックエンドは、関心事の分離を目的とした**レイヤードアーキテクチャ**を採用します。主なレイヤーとその責務は以下の通りです。

1.  **API レイヤー (`app/routers/`)**:

    - HTTP リクエストの受付、パスパラメータ・クエリパラメータの解釈。
    - リクエストボディのバリデーション（`schemas` を利用）。
    - Service レイヤーの呼び出し。
    - Service レイヤーからの結果を HTTP レスポンス（`schemas` を利用）に整形して返却。
    - HTTP レベルのエラーハンドリング（例: 404 Not Found）。
    - 依存性注入（DB セッションなど）の解決。
    - **責務:** HTTP 通信に関わる処理に限定し、「薄く」保つ。

2.  **Service レイヤー (`app/services/`)**:

    - アプリケーション固有のビジネスロジック、ユースケースの実装。
    - 複数の CRUD 操作のオーケストレーション。
    - 複雑なデータ加工や計算。
    - 必要に応じたトランザクション境界の管理（複数ステップにまたがる操作など）。
    - **責務:** アプリケーションの「何をするか」を定義する中心的な層。フレームワークや DB の詳細には直接依存しないことが理想（今回は FastAPI/SQLModel と連携）。

3.  **CRUD レイヤー (`app/crud/`)**:

    - データベースに対する基本的な永続化操作（Create, Read, Update, Delete）。
    - ORM（SQLModel）と DB セッションを利用したデータアクセス。
    - スキーマオブジェクトと DB モデルオブジェクト間の変換。
    - **責務:** 特定のモデルに対する DB 操作をカプセル化。ビジネスロジックは原則として含まない。

4.  **モデルレイヤー (`app/models/`)**:

    - データベースのテーブル構造、カラム、リレーションシップを SQLModel クラスで定義。
    - **責務:** アプリケーションが扱うデータの構造を定義。

5.  **スキーマレイヤー (`app/schemas/`)**:

    - API のインターフェース（リクエスト/レスポンス）で利用するデータの形式、バリデーションルールを Pydantic/SQLModel クラスで定義。
    - **責務:** API のデータコントラクトを定義。

6.  **インフラストラクチャレイヤー (`app/db/`, `app/core/`, etc.)**:
    - データベース接続、設定管理、外部サービス連携など。

### ビジネスロジックの実装場所

複雑なビジネスロジックは、API レイヤー (`routers`) や CRUD レイヤーには実装せず、**Service レイヤー (`services`) に実装**します。

### トランザクション管理

データベーストランザクションは、FastAPI の依存性注入で提供されるリクエスト単位の DB セッション内で管理されます。複数の DB 操作を伴う一連の処理（ユースケース）については、**Service レイヤーでトランザクションの開始・コミット・ロールバックを制御**することを基本方針とします。（単純な CRUD は CRUD 層でコミットする場合もあります）

## ディレクトリ構成

このバックエンドアプリケーションは、関心事の分離を目的として以下のディレクトリ構成を採用しています。

```
├── app/                   # メインのアプリケーションコード
│   ├── init.py
│   ├── main.py          # FastAPI App Entrypoint
│   ├── core/            # コア設定・共通関数 (例: config.py)
│   ├── db/              # DB接続・セッション管理 (例: session.py)
│   ├── models/          # DBモデル定義 (SQLModel) (例: family.py, user.py, task.py)
│   ├── schemas/         # APIスキーマ定義 (Pydantic/SQLModel) (例: family.py, user.py, task.py)
│   ├── crud/            # CRUD操作関数 (例: crud_family.py, crud_user.py, crud_task.py)
│   └── routers/         # APIエンドポイント(ルーティング)定義
│       └── api_v1/      # APIバージョン管理 (例: v1)
│           └── endpoints/ # 各リソースのエンドポイント (例: families.py, users.py, tasks.py)
├── tests/                 # ★ テストコード用ディレクトリ ★
│   ├── init.py
│   ├── conftest.py        # pytestの共通設定・フィクスチャ
│   ├── crud/            # CRUD関数のテスト
│   │   └── test_crud_task.py
│   └── routers/         # APIエンドポイントのテスト
│       └── test_tasks.py
├── .env                 # 環境変数 (Git管理外)
├── .env.example         # 環境変数サンプル
├── .gitignore           # Git無視リスト
├── Dockerfile           # FastAPIアプリ用Dockerfile
├── docker-compose.yml   # Docker Compose設定
├── pyproject.toml       # プロジェクト設定 (Ruffなど)
└── requirements.txt     # Python依存ライブラリ
```

### 各ディレクトリの役割

- **`app/`**: アプリケーションの主要なソースコードが含まれます。
  - **`core/`**: 設定ファイルや共通のユーティリティ関数など。
  - **`db/`**: データベースセッションの管理など、データベース接続に関連するコード。
  - **`models/`**: データベースのテーブル構造に対応する SQLModel クラス。
  - **`schemas/`**: API リクエスト/レスポンスのデータ形式を定義する Pydantic/SQLModel クラス。
  - **`crud/`**: データベースに対する基本的な作成(Create)、読み取り(Read)、更新(Update)、削除(Delete)操作を行う関数群。ビジネスロジックは最小限に。
  - **`routers/`**: API のエンドポイントを定義し、リクエストを受け付け、適切な CRUD 関数やビジネスロジックを呼び出す部分。
- **`tests/`**: 自動テストのコードが含まれます。（後述）
- **(ルートディレクトリ)**: Docker 設定ファイル、依存関係ファイル、プロジェクト設定ファイルなど。

## テスト戦略

### 基本方針

本プロジェクトにおけるテストの主な目的は、コア機能の正常動作を確認し、重要な箇所でのリグレッション（意図しない変更によるバグの再発）を防ぎ、リファクタリングを安心して行えるようにすることです。開発スピードを優先し、網羅的なテストや高いコードカバレッジ率を目標とはせず、ビジネス価値の高い部分に絞って意味のあるテストを記述します。

### 使用ツール

- テストランナー: `pytest`
- API テストクライアント: `httpx` (FastAPI の`TestClient`経由で使用)
- (必要に応じて) モックライブラリ: `unittest.mock` (標準), `pytest-mock`

### テスト環境

- 開発中および CI におけるテストの実行速度を重視し、原則として**インメモリ SQLite データベース** (`sqlite+aiosqlite:///:memory:`) を使用します。
- **注意点:** SQLite と本番環境の PostgreSQL では差異が生じる可能性（JSON 型、特定関数等）があるため、PostgreSQL 固有機能に強く依存するテストが必要な場合は別途検討します。

### テスト対象の優先順位

1.  **API エンドポイント (Integration Tests - 最優先):**

    - FastAPI の`TestClient`を使用し、API へのリクエストとレスポンスを検証します。
    - **テスト内容:** 主要リソースの CRUD 正常系、**認可**（他家族データへのアクセス不可）、基本的な入力バリデーション（422 エラー）。
    - **アサーション:** 主に API の**ステータスコード**と**レスポンスボディの内容**（スキーマ合致、主要データ）を検証します。スピードを優先し、**全てのテストで DB の内容を直接確認することはせず**、API の応答で十分と判断できる場合はそれを信頼します。DB 永続化の確認が特に重要な場合に限り、DB を直接確認します。
    - **配置場所:** `tests/routers/`

2.  **Service レイヤーのビジネスロジック (Unit Tests - 複雑な場合に推奨):**

    - `app/services/` に、単なる CRUD 呼び出し以上の**複雑なロジック**が実装された場合、そのロジックを単体でテストします。
    - **テスト方法:** Service 関数を直接呼び出し、依存する CRUD 関数や DB セッションは**モック**に差し替えて、ロジックの正しさのみを高速に検証します。
    - **配置場所:** `tests/services/` （必要に応じて作成）

3.  **コアな CRUD 関数 (任意 - Unit/Integration Tests):**
    - `app/crud/` の関数が複雑な DB クエリ等を含む場合のみ、必要に応じてテストします。シンプルなものは API テストでカバーします。
    - **配置場所:** `tests/crud/`

### テスト対象としないもの（初期）

- 単純な Models/Schemas 定義（カスタムバリデーション等がない限り）
- 全ての境界値・エッジケース
- 外部ライブラリ自体のテスト
- コードカバレッジ率の追求

### テストファイルの構成

テストコードはプロジェクトルートの `tests/` ディレクトリに配置し、`app/` ディレクトリの構造を参考にファイルを整理します。共通設定は `tests/conftest.py` に記述します。
